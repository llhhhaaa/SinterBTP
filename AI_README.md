# AI_README - 烧结终点温度(BTP)预测系统深度理解手册

> **重要说明**：本文档旨在为后续接手的 AI 助手提供全方位、无死角的工程上下文。它不仅涵盖了"是什么"，更深入解释了"为什么"和"怎么做"。阅读本文档后，你应该能够像原作者一样精准地操控代码，避免任何逻辑上的误区或幻觉。

---

## 1. 工程核心元数据与物理背景

*   **项目定义**：一个高精度、具有不确定性量化能力的烧结终点温度（BTP）预测系统。
*   **开发状态**：**本科毕业设计（进行中）**。
*   **物理对象**：大型烧结机。通过控制机速、负压等参数，确保烧结过程在预定位置（BTP）达到最高温度。
*   **核心挑战**：
    *   **时延性**：操作动作与结果之间存在显著滞后（分钟级）。
    *   **非平稳性**：原料、班次、环境导致的数据分布随时间漂移（Distribution Shift）。
    *   **不确定性**：传感器噪声大，单点预测不足以支撑决策。
*   **技术路线**：`EnhancedTransformer` = `RevIN(仅输入端归一化)` + 输入投影 + `Time2Vec(可学习时间编码)` + `Transformer Encoder` + 物理特征拼接 + `QuantileDeltaHead`（**直接输出绝对分位数**）。

---

## 2. 核心架构深度拆解 (Implementation Details)

### 2.1 EnhancedTransformer（当前方案）
```
输入 (B, T, D)
    ↓
RevIN(仅输入端归一化，消除分布漂移)
    ↓
输入投影 (Linear)
    ↓
Time2Vec(可学习时间编码)
    ↓
Transformer Encoder
    ↓
取最后时刻特征
    ↓
拼接物理特征 (BTP_Peak, BTP_Pos, etc.)
    ↓
QuantileDeltaHead（直接输出5分位数）
    ↓
输出 (B, Steps, 5) -> [Q10, Q25, Q50, Q75, Q90]
```
*   **RevIN**：逐样本归一化，减少分布漂移。当前实现中仅做输入端归一化，输出头自行学习正确尺度。
*   **Time2Vec**：可学习的时间表示，替代固定正弦位置编码。MAE 降低 3.3%，RMSE 降低 2.1%。
*   **QuantileDeltaHead**：基于 `Softplus` 的链式结构，数学上保证 $Q_{10} \leq Q_{25} \leq Q_{50} \leq Q_{75} \leq Q_{90}$，彻底消除分位数交叉现象。

### 2.2 特征引擎 (Physics Engine) [`btp/preprocessor.py`](btp/preprocessor.py)
*   **三次样条插值**：利用 15# 到 24# 风箱的离散温度点，构建 5000 点连续物理形状。
*   **关键衍生特征**：`BTP_Pos` (峰值坐标), `BTP_Peak` (峰值温度), `Slope` (热量斜率), `AUC` (累积热量)。

### 2.3 增强损失函数 (QuantileLoss) [`btp/model.py`](btp/model.py)
*   **复合约束**：Pinball Loss + Coverage Penalty (二阶覆盖惩罚) + Min Width (防止区间坍缩) + Smoothness (趋势平滑)。

### 2.4 健康度模型 (HealthModel MDPHI v2.0) [`btp/health_model.py`](btp/health_model.py)
*   **三维评分**:
    *   **静态偏离度 (H_pos)**: 中位数与工艺目标的距离。
    *   **动态稳定性 (H_stab)**: 局部波动幅度。
    *   **趋势风险度 (H_trend)**: 偏离方向的瞬时速度。
*   **平滑与判定**:
    *   **二阶 EWMA**: 两级级联滤波，提供极度丝滑的评分曲线且无超调。
    *   **施密特触发器**: 引入迟滞带宽（Hysteresis Band），防止工况状态在阈值边缘频繁闪烁。

---

## 3. 规范化目录结构

```text
btp_project/
├── btp/                      # 核心算法包
│   ├── model.py              # Enhanced Transformer 架构与分位数 Loss
│   ├── health_model.py       # MDPHI v2.0 健康度评分引擎
│   ├── preprocessor.py       # 物理特征引擎 (CubicSpline) 与数据预处理
│   ├── data_loader.py        # 滑动窗口序列构建
│   ├── trainer.py            # 训练逻辑、Warmup 与复合优化策略
│   ├── config.py             # 集中化配置管理 (TrainConfig)
│   ├── metrics.py            # 分位数专用评价指标 (PICP, PINAW, etc.)
│   └── visualizer.py         # 预测结果与健康度深度可视化
├── scripts/                  # 运行与自动化脚本
│   ├── main.py               # 生产/实验统一入口
│   ├── tune_health_params.py # 健康度模型交互式调优台 (GUI)
│   ├── run_ablation.py       # 自动化消融实验调度
│   └── analyze_results.py    # 实验结果统计分析
├── data/                     # 数据存储 (原始 Excel、Scaler 缓存、实验结果)
├── logs/                     # 训练与系统日志
├── tests/                    # 单元测试 (模型前向、插值逻辑)
└── tools/                    # 辅助工具 (文档转换、数据复制等)
```

---

## 4. 开发状态与重大重构记录

### 4.1 状态概览
- **当前阶段**: 本科毕业设计（进行中）
- **核心目标**: 提升 BTP 预测的物理一致性与区间覆盖率，并实现鲁棒的工况识别。

### 4.2 重构历程 (Major Refactorings)
- **2026-02-27 [Current]**: 
    - **健康度引擎升级**: 发布 MDPHI v2.0，引入二阶 EWMA 平滑与施密特触发器。
    - **调优工具集成**: 推出 `tune_health_params.py`，支持基于 Corr & MAE 的自动参数标定。
- **2026-02-22**: 
    - **架构剪枝**: 废弃 CrossFeatureAttention 与 CQR 校准，回归奥卡姆剃刀原则。
    - **时间编码升级**: 引入 Time2Vec 替代静态 PE。
    - **分位数逻辑变更**: 从 Delta 预测回归为直接分位数预测，配合 Softplus 保证单调性。
- **2026-02-18**: 
    - **数据协议修复**: 修正 BTP 目标值被误截断导致的“阶梯状失真” Bug。
    - **目录规范化**: 完成从松散脚本向规范 `btp/` 算法库的迁移。

---

## 5. 核心文件索引清单

| 文件 | 关键职责 | 核心代码块/类 |
| :--- | :--- | :--- |
| [`btp/config.py`](btp/config.py) | 全局超参数与实验开关 | `TrainConfig` |
| [`btp/model.py`](btp/model.py) | 模型定义与损失函数 | `EnhancedTransformer`, `QuantileLoss` |
| [`btp/health_model.py`](btp/health_model.py) | 业务逻辑转化 | `HealthModel` (MDPHI v2.0) |
| [`btp/preprocessor.py`](btp/preprocessor.py) | 物理特征提取 | `_extract_spline_features` |
| [`scripts/main.py`](scripts/main.py) | 实验流水线控制 | `main()` 优先级调度逻辑 |
| [`scripts/tune_health_params.py`](scripts/tune_health_params.py) | 交互式调优 | `HealthVisualizerApp` |

---
*Generated by Documentation Writer | Last Updated: 2026-02-27*
